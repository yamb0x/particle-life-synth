<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trail Exclusion Performance Test</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a1a;
            color: #fff;
        }
        
        canvas {
            border: 1px solid #444;
            display: block;
            margin: 20px auto;
        }
        
        .controls {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #2a2a2a;
            border-radius: 8px;
        }
        
        .test-section {
            margin: 20px 0;
            padding: 15px;
            background: #333;
            border-radius: 5px;
        }
        
        h1 {
            text-align: center;
            color: #4CAF50;
        }
        
        h3 {
            color: #FFC107;
            margin-top: 0;
        }
        
        .test-result {
            padding: 10px;
            margin: 10px 0;
            background: #444;
            border-radius: 3px;
            font-family: monospace;
        }
        
        .success {
            background: #2E7D32;
        }
        
        .warning {
            background: #F57C00;
        }
        
        .error {
            background: #C62828;
        }
        
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        
        button:hover {
            background: #45a049;
        }
        
        .fps-display {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 16px;
        }
        
        .control-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }
        
        label {
            min-width: 150px;
        }
        
        input[type="range"] {
            width: 200px;
        }
        
        select {
            padding: 5px;
            background: #444;
            color: white;
            border: 1px solid #666;
            border-radius: 3px;
        }
        
        .performance-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        
        .performance-table th,
        .performance-table td {
            padding: 10px;
            text-align: left;
            border: 1px solid #555;
        }
        
        .performance-table th {
            background: #444;
            color: #FFC107;
        }
        
        .performance-table td {
            background: #333;
        }
        
        .improved {
            color: #4CAF50;
            font-weight: bold;
        }
        
        .degraded {
            color: #F44336;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>🧪 Trail Exclusion Performance Test</h1>
    
    <div class="fps-display">
        FPS: <span id="fps">0</span> | 
        Particles: <span id="particle-count">0</span> |
        Species: <span id="species-count">5</span>
    </div>
    
    <canvas id="canvas" width="1200" height="600"></canvas>
    
    <div class="controls">
        <div class="test-section">
            <h3>Performance Comparison</h3>
            <div class="control-row">
                <label>Number of Species:</label>
                <input type="range" id="species-slider" min="2" max="10" value="5">
                <span id="species-value">5</span>
            </div>
            <div class="control-row">
                <label>Particles per Species:</label>
                <input type="range" id="particles-slider" min="50" max="300" value="100">
                <span id="particles-value">100</span>
            </div>
            <div class="control-row">
                <button onclick="testLegacyMode()">Test Legacy Per-Species Mode</button>
                <button onclick="testExclusionMode()">Test New Exclusion Mode</button>
                <button onclick="testLinkedMode()">Test Linked Mode (Baseline)</button>
            </div>
            
            <table class="performance-table">
                <thead>
                    <tr>
                        <th>Mode</th>
                        <th>Avg FPS</th>
                        <th>Min FPS</th>
                        <th>Max FPS</th>
                        <th>Frame Time (ms)</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="performance-results">
                </tbody>
            </table>
        </div>
        
        <div class="test-section">
            <h3>Trail Exclusion Controls</h3>
            <div class="control-row">
                <label>
                    <input type="checkbox" id="link-all-trails" checked>
                    Link All Species
                </label>
            </div>
            <div class="control-row" id="exclusion-row" style="display: none;">
                <label>
                    <input type="checkbox" id="exclusion-enabled">
                    Enable Exclusion Mode
                </label>
            </div>
            <div class="control-row" id="species-selector-row" style="display: none;">
                <label>Excluded Species:</label>
                <select id="excluded-species">
                    <option value="-1">None</option>
                    <option value="0">Red</option>
                    <option value="1">Green</option>
                    <option value="2">Blue</option>
                    <option value="3">Yellow</option>
                    <option value="4">Purple</option>
                </select>
            </div>
            <div class="control-row">
                <label>Trail Length:</label>
                <input type="range" id="trail-length" min="0.5" max="0.99" step="0.01" value="0.95">
                <span id="trail-value">0.95</span>
            </div>
        </div>
        
        <div class="test-section">
            <h3>Test Results</h3>
            <div id="test-results"></div>
        </div>
    </div>
    
    <script type="module">
        import { SimpleParticleSystem } from './src/core/SimpleParticleSystem.js';
        
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const particleSystem = new SimpleParticleSystem(5, 100);
        
        particleSystem.setCanvas(canvas);
        particleSystem.width = canvas.width;
        particleSystem.height = canvas.height;
        
        // Performance tracking
        let frameCount = 0;
        let lastTime = performance.now();
        let fps = 0;
        let fpsHistory = [];
        let minFps = 1000;
        let maxFps = 0;
        let testMode = null;
        let testStartTime = 0;
        const testDuration = 5000; // 5 seconds per test
        
        // Initialize controls
        function initControls() {
            // Species count
            const speciesSlider = document.getElementById('species-slider');
            const speciesValue = document.getElementById('species-value');
            speciesSlider.addEventListener('input', (e) => {
                const value = parseInt(e.target.value);
                speciesValue.textContent = value;
                particleSystem.setNumSpecies(value);
                updateSpeciesSelector();
                document.getElementById('species-count').textContent = value;
            });
            
            // Particles per species
            const particlesSlider = document.getElementById('particles-slider');
            const particlesValue = document.getElementById('particles-value');
            particlesSlider.addEventListener('input', (e) => {
                const value = parseInt(e.target.value);
                particlesValue.textContent = value;
                particleSystem.particlesPerSpecies = value;
                particleSystem.initializeParticles();
                document.getElementById('particle-count').textContent = particleSystem.particles.length;
            });
            
            // Trail controls
            document.getElementById('link-all-trails').addEventListener('change', (e) => {
                const linked = e.target.checked;
                particleSystem.linkAllSpeciesTrails = linked;
                document.getElementById('exclusion-row').style.display = linked ? 'none' : 'block';
                
                if (linked) {
                    particleSystem.setTrailExclusion(false);
                    document.getElementById('exclusion-enabled').checked = false;
                    document.getElementById('species-selector-row').style.display = 'none';
                }
            });
            
            document.getElementById('exclusion-enabled').addEventListener('change', (e) => {
                const enabled = e.target.checked;
                const speciesId = parseInt(document.getElementById('excluded-species').value);
                
                if (enabled) {
                    particleSystem.setTrailExclusion(true, speciesId, particleSystem.blur);
                    document.getElementById('species-selector-row').style.display = 'block';
                } else {
                    particleSystem.setTrailExclusion(false);
                    document.getElementById('species-selector-row').style.display = 'none';
                }
            });
            
            document.getElementById('excluded-species').addEventListener('change', (e) => {
                const speciesId = parseInt(e.target.value);
                if (particleSystem.trailExclusionEnabled) {
                    particleSystem.excludedSpeciesId = speciesId;
                }
            });
            
            document.getElementById('trail-length').addEventListener('input', (e) => {
                const value = parseFloat(e.target.value);
                document.getElementById('trail-value').textContent = value.toFixed(2);
                particleSystem.blur = value;
                
                if (particleSystem.trailExclusionEnabled) {
                    particleSystem.excludedSpeciesTrail = value;
                }
            });
        }
        
        function updateSpeciesSelector() {
            const selector = document.getElementById('excluded-species');
            const currentValue = selector.value;
            selector.innerHTML = '<option value="-1">None</option>';
            
            const colors = ['Red', 'Green', 'Blue', 'Yellow', 'Purple', 'Cyan', 'Magenta', 'Orange', 'Pink', 'White'];
            for (let i = 0; i < particleSystem.numSpecies; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = colors[i] || `Species ${i}`;
                selector.appendChild(option);
            }
            
            if (currentValue && parseInt(currentValue) < particleSystem.numSpecies) {
                selector.value = currentValue;
            }
        }
        
        // Test functions
        window.testLegacyMode = function() {
            startTest('legacy');
            particleSystem.linkAllSpeciesTrails = false;
            particleSystem.setTrailExclusion(false);
            
            // Set different trail values for each species (worst case scenario)
            for (let i = 0; i < particleSystem.numSpecies; i++) {
                particleSystem.setSpeciesTrail(i, 0.5 + Math.random() * 0.49);
            }
            
            addResult('Testing Legacy Per-Species Mode...', 'warning');
        };
        
        window.testExclusionMode = function() {
            startTest('exclusion');
            particleSystem.linkAllSpeciesTrails = false;
            particleSystem.setTrailExclusion(true, 0, 0.7); // Exclude first species with different trail
            
            addResult('Testing New Exclusion Mode...', 'success');
        };
        
        window.testLinkedMode = function() {
            startTest('linked');
            particleSystem.linkAllSpeciesTrails = true;
            particleSystem.setTrailExclusion(false);
            
            addResult('Testing Linked Mode (Baseline)...', 'success');
        };
        
        function startTest(mode) {
            testMode = mode;
            testStartTime = performance.now();
            fpsHistory = [];
            minFps = 1000;
            maxFps = 0;
        }
        
        function endTest() {
            if (!testMode) return;
            
            const avgFps = fpsHistory.reduce((a, b) => a + b, 0) / fpsHistory.length;
            const avgFrameTime = 1000 / avgFps;
            
            addPerformanceResult(testMode, avgFps, minFps, maxFps, avgFrameTime);
            
            testMode = null;
        }
        
        function addPerformanceResult(mode, avgFps, minFps, maxFps, frameTime) {
            const tbody = document.getElementById('performance-results');
            const row = document.createElement('tr');
            
            const modeNames = {
                'legacy': 'Legacy Per-Species',
                'exclusion': 'New Exclusion Mode',
                'linked': 'Linked (Baseline)'
            };
            
            const status = avgFps >= 30 ? '✅ Good' : avgFps >= 20 ? '⚠️ Acceptable' : '❌ Poor';
            const statusClass = avgFps >= 30 ? 'improved' : avgFps >= 20 ? '' : 'degraded';
            
            row.innerHTML = `
                <td>${modeNames[mode]}</td>
                <td>${avgFps.toFixed(1)}</td>
                <td>${minFps.toFixed(1)}</td>
                <td>${maxFps.toFixed(1)}</td>
                <td>${frameTime.toFixed(2)}</td>
                <td class="${statusClass}">${status}</td>
            `;
            
            tbody.appendChild(row);
        }
        
        function addResult(message, type = '') {
            const resultsDiv = document.getElementById('test-results');
            const result = document.createElement('div');
            result.className = `test-result ${type}`;
            result.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            resultsDiv.appendChild(result);
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }
        
        // Animation loop
        function animate() {
            const currentTime = performance.now();
            const deltaTime = currentTime - lastTime;
            
            // Update FPS
            frameCount++;
            if (deltaTime >= 1000) {
                fps = frameCount;
                frameCount = 0;
                lastTime = currentTime;
                document.getElementById('fps').textContent = fps;
                
                // Track FPS during tests
                if (testMode) {
                    fpsHistory.push(fps);
                    minFps = Math.min(minFps, fps);
                    maxFps = Math.max(maxFps, fps);
                    
                    // End test after duration
                    if (currentTime - testStartTime >= testDuration) {
                        endTest();
                    }
                }
            }
            
            // Update particle system
            particleSystem.update(0.016); // 60 FPS target
            
            requestAnimationFrame(animate);
        }
        
        // Initialize
        initControls();
        updateSpeciesSelector();
        document.getElementById('particle-count').textContent = particleSystem.particles.length;
        
        // Set up some interesting forces for visual appeal
        particleSystem.randomizeForces();
        particleSystem.trailEnabled = true;
        
        // Start animation
        animate();
        
        // Initial test message
        addResult('Trail Exclusion Performance Test Ready', 'success');
        addResult('Click the test buttons to compare performance between modes', '');
        
        // Make particle system accessible for debugging
        window.particleSystem = particleSystem;
    </script>
</body>
</html>
<!DOCTYPE html>
<html>
<head>
    <title>Debug Color Export Issue</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        .color-display { width: 30px; height: 30px; display: inline-block; margin: 5px; border: 1px solid #000; }
        button { margin: 5px; padding: 8px 15px; }
        pre { background: #f5f5f5; padding: 10px; }
    </style>
</head>
<body>
    <h1>Debug: Color Export Issue</h1>
    
    <div class="test-section">
        <h2>Issue Description</h2>
        <p>When opening the configuration modal, the colors are being reset to defaults instead of showing current colors.</p>
        <p><strong>Expected:</strong> Modal shows current particle colors</p>
        <p><strong>Actual:</strong> Modal shows default colors, overwriting user preferences</p>
    </div>
    
    <div class="test-section">
        <h2>Test Color Export</h2>
        <button onclick="testColorExport()">Test Current Colors</button>
        <button onclick="testModalOpen()">Test Modal Open</button>
        <div id="results"></div>
    </div>
    
    <script>
        function testColorExport() {
            const results = document.getElementById('results');
            
            // Check if we can access the main window
            let mainWindow = window.parent;
            if (!mainWindow || !mainWindow.particleSystem) {
                mainWindow = window.opener;
            }
            
            if (!mainWindow || !mainWindow.particleSystem) {
                results.innerHTML = '<p style="color: red;">Error: Cannot access particle system. Open this page from the main application.</p>';
                return;
            }
            
            const particleSystem = mainWindow.particleSystem;
            
            try {
                // Test 1: Check current particle system species colors
                console.log('Current species colors:', particleSystem.species.map(s => s.color));
                
                // Test 2: Export preset and check colors
                const exported = particleSystem.exportPreset();
                console.log('Exported preset colors:', exported.species.definitions.map(s => s.color));
                
                // Test 3: Check if colors match
                const currentColors = particleSystem.species.map(s => s.color);
                const exportedColors = exported.species.definitions.map(s => s.color);
                
                let html = '<h3>Color Export Test Results</h3>';
                html += '<h4>Current Particle System Colors:</h4>';
                currentColors.forEach((color, i) => {
                    html += `<div>Species ${i}: <span class="color-display" style="background-color: rgb(${color.r}, ${color.g}, ${color.b})"></span> RGB(${color.r}, ${color.g}, ${color.b})</div>`;
                });
                
                html += '<h4>Exported Preset Colors:</h4>';
                exportedColors.forEach((color, i) => {
                    html += `<div>Species ${i}: <span class="color-display" style="background-color: rgb(${color.r}, ${color.g}, ${color.b})"></span> RGB(${color.r}, ${color.g}, ${color.b})</div>`;
                });
                
                // Check if colors match
                const colorsMatch = currentColors.every((color, i) => {
                    const exported = exportedColors[i];
                    return color.r === exported.r && color.g === exported.g && color.b === exported.b;
                });
                
                html += `<h4>Colors Match: ${colorsMatch ? '✓ YES' : '✗ NO'}</h4>`;
                
                if (!colorsMatch) {
                    html += '<p style="color: red;">Problem: Colors don\'t match between particle system and export!</p>';
                }
                
                results.innerHTML = html;
                
            } catch (error) {
                results.innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
            }
        }
        
        function testModalOpen() {
            const results = document.getElementById('results');
            
            let mainWindow = window.parent;
            if (!mainWindow || !mainWindow.presetModal) {
                mainWindow = window.opener;
            }
            
            if (!mainWindow || !mainWindow.presetModal) {
                results.innerHTML = '<p style="color: red;">Error: Cannot access preset modal. Open this page from the main application.</p>';
                return;
            }
            
            try {
                // Test opening modal with current state
                console.log('Testing modal open with empty string (Custom)');
                
                // Check colors before opening modal
                const beforeColors = mainWindow.particleSystem.species.map(s => s.color);
                console.log('Colors before modal open:', beforeColors);
                
                // Open modal
                mainWindow.presetModal.open('');
                
                // Check colors after opening modal
                const afterColors = mainWindow.particleSystem.species.map(s => s.color);
                console.log('Colors after modal open:', afterColors);
                
                // Check if colors changed
                const colorsChanged = !beforeColors.every((color, i) => {
                    const after = afterColors[i];
                    return color.r === after.r && color.g === after.g && color.b === after.b;
                });
                
                let html = '<h3>Modal Open Test Results</h3>';
                html += `<h4>Colors Changed During Modal Open: ${colorsChanged ? '✗ YES (BUG!)' : '✓ NO'}</h4>`;
                
                if (colorsChanged) {
                    html += '<p style="color: red;">This confirms the bug: Opening the modal changes the colors!</p>';
                } else {
                    html += '<p style="color: green;">Modal opening preserved colors correctly.</p>';
                }
                
                results.innerHTML = html;
                
            } catch (error) {
                results.innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
            }
        }
    </script>
</body>
</html>
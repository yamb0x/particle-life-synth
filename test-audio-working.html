<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Audio Working Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #1a1a1a;
            color: white;
            padding: 20px;
        }
        
        .test-section {
            background: #2a2a2a;
            border: 2px solid #4CAF50;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        
        button:hover {
            background: #45a049;
        }
        
        .status {
            margin: 10px 0;
            padding: 10px;
            background: #333;
            border-radius: 4px;
        }
        
        .success { color: #4CAF50; }
        .error { color: #F44336; }
        .warning { color: #FFC107; }
    </style>
</head>
<body>
    <h1>üéµ Audio System Working Test</h1>
    
    <div class="test-section">
        <h2>Step 1: Test Basic Web Audio</h2>
        <button onclick="testWebAudio()">Test Web Audio API</button>
        <div id="status1" class="status">Click to test basic Web Audio</div>
    </div>
    
    <div class="test-section">
        <h2>Step 2: Initialize & Load Sample</h2>
        <button onclick="initAndLoad()">Initialize System & Load Sample</button>
        <div id="status2" class="status">Click to initialize audio system</div>
    </div>
    
    <div class="test-section">
        <h2>Step 3: Play Loaded Sample</h2>
        <button onclick="playLoadedSample()">Play Sample</button>
        <div id="status3" class="status">Initialize system first</div>
    </div>
    
    <div class="test-section">
        <h2>Step 4: Test Granular Synthesis</h2>
        <button onclick="testGranular()">Play Grains</button>
        <div id="status4" class="status">Load sample first</div>
    </div>
    
    <script type="module">
        import { getAudioSystem } from './src/audio/AudioSystem.js';
        
        let loadedBuffer = null;
        let audioSystem = null;
        
        // Step 1: Test basic Web Audio
        window.testWebAudio = function() {
            const status = document.getElementById('status1');
            
            try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                
                // Simple beep
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                
                osc.frequency.value = 440;
                gain.gain.value = 0.2;
                
                osc.connect(gain);
                gain.connect(ctx.destination);
                
                osc.start();
                osc.stop(ctx.currentTime + 0.2);
                
                status.innerHTML = '<span class="success">‚úÖ Web Audio working! You should hear a beep.</span>';
            } catch (error) {
                status.innerHTML = `<span class="error">‚ùå Error: ${error.message}</span>`;
            }
        };
        
        // Step 2: Initialize and load a sample
        window.initAndLoad = async function() {
            const status = document.getElementById('status2');
            
            try {
                status.innerHTML = 'Initializing audio system...';
                
                audioSystem = getAudioSystem();
                
                if (!audioSystem.isInitialized) {
                    await audioSystem.initialize(800, 600);
                    
                    // Resume if suspended
                    if (audioSystem.audioEngine.audioContext.state === 'suspended') {
                        await audioSystem.audioEngine.resume();
                    }
                }
                
                status.innerHTML = 'Loading sample...';
                
                // Try to load a sample that definitely exists
                const samplePath = 'stems/Turbulent Beat (2).wav';
                loadedBuffer = await audioSystem.sampleManager.loadSample(samplePath);
                
                status.innerHTML = `<span class="success">‚úÖ System initialized! Sample loaded: ${loadedBuffer.duration.toFixed(2)}s</span>`;
                document.getElementById('status3').innerHTML = 'Ready to play';
                document.getElementById('status4').innerHTML = 'Ready for granular synthesis';
                
            } catch (error) {
                status.innerHTML = `<span class="error">‚ùå Error: ${error.message}</span>`;
                console.error(error);
            }
        };
        
        // Step 3: Play the loaded sample
        window.playLoadedSample = function() {
            const status = document.getElementById('status3');
            
            if (!loadedBuffer || !audioSystem) {
                status.innerHTML = '<span class="warning">‚ö†Ô∏è Please initialize and load sample first</span>';
                return;
            }
            
            try {
                const ctx = audioSystem.audioEngine.audioContext;
                const source = ctx.createBufferSource();
                const gain = ctx.createGain();
                
                source.buffer = loadedBuffer;
                gain.gain.value = 0.5;
                
                source.connect(gain);
                gain.connect(audioSystem.audioEngine.masterGain);
                
                source.start();
                
                status.innerHTML = '<span class="success">‚úÖ Playing full sample through master gain</span>';
            } catch (error) {
                status.innerHTML = `<span class="error">‚ùå Error: ${error.message}</span>`;
            }
        };
        
        // Step 4: Test granular synthesis
        window.testGranular = function() {
            const status = document.getElementById('status4');
            
            if (!loadedBuffer || !audioSystem) {
                status.innerHTML = '<span class="warning">‚ö†Ô∏è Please load sample first</span>';
                return;
            }
            
            try {
                const ctx = audioSystem.audioEngine.audioContext;
                
                // Play 5 grains with random positions
                for (let i = 0; i < 5; i++) {
                    setTimeout(() => {
                        const source = ctx.createBufferSource();
                        const gain = ctx.createGain();
                        const panner = ctx.createStereoPanner();
                        
                        source.buffer = loadedBuffer;
                        
                        // Random grain parameters
                        const startPos = Math.random() * loadedBuffer.duration;
                        const grainSize = 0.05 + Math.random() * 0.1; // 50-150ms
                        const pan = (Math.random() - 0.5) * 2; // -1 to 1
                        
                        // Grain envelope
                        const now = ctx.currentTime;
                        gain.gain.setValueAtTime(0, now);
                        gain.gain.linearRampToValueAtTime(0.3, now + 0.005);
                        gain.gain.linearRampToValueAtTime(0.3, now + grainSize - 0.005);
                        gain.gain.linearRampToValueAtTime(0, now + grainSize);
                        
                        panner.pan.value = pan;
                        
                        source.connect(gain);
                        gain.connect(panner);
                        panner.connect(audioSystem.audioEngine.masterGain);
                        
                        source.start(now, startPos, grainSize);
                    }, i * 100); // Stagger grains
                }
                
                status.innerHTML = '<span class="success">‚úÖ Playing 5 grains with random positions</span>';
            } catch (error) {
                status.innerHTML = `<span class="error">‚ùå Error: ${error.message}</span>`;
            }
        };
        
        // Check if samples actually exist
        fetch('stems/manifest.json')
            .then(r => r.json())
            .then(manifest => {
                console.log('Available samples:', manifest.count);
                console.log('First 5 samples:', manifest.files.slice(0, 5));
            })
            .catch(e => console.error('Could not load manifest:', e));
    </script>
</body>
</html>
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Firebase Status Test</title>
    <style>
        body {
            font-family: monospace;
            background: #1a1a1a;
            color: #ccc;
            padding: 20px;
        }
        .test {
            margin: 10px 0;
            padding: 10px;
            background: #2a2a2a;
            border-radius: 5px;
        }
        .pass { color: #4a9eff; }
        .fail { color: #ff4444; }
        .info { color: #888; }
        button {
            margin: 5px;
            padding: 8px 15px;
            background: #4a9eff;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        button:hover {
            background: #3a8eff;
        }
    </style>
</head>
<body>
    <h1>Firebase Status Test</h1>
    <div id="results"></div>
    <br>
    <button onclick="checkStatus()">Check Status Again</button>
    <button onclick="checkPresets()">List All Presets</button>
    
    <script type="module">
        const results = document.getElementById('results');
        
        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `test ${type}`;
            div.textContent = message;
            results.appendChild(div);
        }
        
        window.checkStatus = async function() {
            results.innerHTML = '';
            log('Checking Firebase status...', 'info');
            
            // Wait for app to load
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            // Check if mainUI exists
            if (!window.mainUI) {
                log('❌ MainUI not loaded yet', 'fail');
                return;
            }
            
            // Check presetManager
            if (!window.mainUI.presetManager) {
                log('❌ PresetManager not available', 'fail');
                return;
            }
            
            const presetManager = window.mainUI.presetManager;
            
            // Check cloud status
            const isCloudEnabled = presetManager.isCloudEnabled();
            log(`Cloud Enabled: ${isCloudEnabled ? '✅ Yes' : '❌ No'}`, isCloudEnabled ? 'pass' : 'fail');
            
            // Get cloud status details
            const cloudStatus = presetManager.getCloudStatus();
            log('Cloud Status Details:', 'info');
            log(`   Enabled: ${cloudStatus.enabled}`, 'info');
            log(`   Authenticated: ${cloudStatus.authenticated}`, 'info');
            log(`   User ID: ${cloudStatus.userId || 'None'}`, 'info');
            log(`   Preset Count (Map): ${cloudStatus.presetCount}`, 'info');
            log(`   Syncing: ${cloudStatus.syncing}`, 'info');
            
            // Get all presets
            const allPresets = presetManager.getUserPresets();
            log(`Total Presets: ${allPresets.length}`, 'info');
            
            // Count cloud presets by different methods
            const cloudByIsCloud = allPresets.filter(p => p.isCloud).length;
            const cloudByKey = allPresets.filter(p => p.key?.startsWith('cloud_')).length;
            const cloudBySource = allPresets.filter(p => p.source === 'cloud').length;
            
            log('Cloud Preset Count Methods:', 'info');
            log(`   By isCloud flag: ${cloudByIsCloud}`, cloudByIsCloud > 0 ? 'pass' : 'info');
            log(`   By cloud_ key prefix: ${cloudByKey}`, cloudByKey > 0 ? 'pass' : 'info');
            log(`   By source property: ${cloudBySource}`, 'info');
            
            // Check UI elements
            const statusEl = document.getElementById('connection-status');
            const countEl = document.getElementById('preset-count');
            
            if (statusEl && countEl) {
                log('UI Status Display:', 'info');
                log(`   Connection: "${statusEl.textContent}"`, 'info');
                log(`   Count: "${countEl.textContent}"`, 'info');
                
                // Check if count matches
                const displayedCount = parseInt(countEl.textContent.match(/\d+/)?.[0] || '0');
                const expectedCount = Math.max(cloudStatus.presetCount, cloudByIsCloud, cloudByKey);
                
                if (displayedCount === expectedCount && displayedCount > 0) {
                    log(`✅ UI shows correct count: ${displayedCount}`, 'pass');
                } else if (displayedCount === 0 && expectedCount > 0) {
                    log(`❌ UI shows 0 but should show ${expectedCount}`, 'fail');
                } else {
                    log(`⚠️ UI shows ${displayedCount}, expected ${expectedCount}`, displayedCount > 0 ? 'info' : 'fail');
                }
            } else {
                log('❌ Status UI elements not found', 'fail');
            }
            
            // Check Firebase/Firestore connection
            if (window.cloudStorage) {
                const isAuth = window.cloudStorage.isAuthenticated();
                log(`Firebase Authentication: ${isAuth ? '✅ Yes' : '❌ No'}`, isAuth ? 'pass' : 'fail');
            }
        }
        
        window.checkPresets = function() {
            results.innerHTML = '';
            
            if (!window.mainUI || !window.mainUI.presetManager) {
                log('❌ App not loaded', 'fail');
                return;
            }
            
            const presets = window.mainUI.presetManager.getUserPresets();
            log(`Found ${presets.length} presets:`, 'info');
            
            presets.forEach((preset, index) => {
                const isCloud = preset.isCloud || preset.key?.startsWith('cloud_');
                const icon = isCloud ? '☁️' : '💾';
                log(`${index + 1}. ${icon} ${preset.name} (key: ${preset.key})`, isCloud ? 'pass' : 'info');
            });
        }
        
        // Run initial check
        setTimeout(() => checkStatus(), 3000);
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test New Collision System</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background: #111;
            color: #fff;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #333;
            border-radius: 8px;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            background: #222;
            border-radius: 4px;
            font-family: monospace;
        }
        .success { border-left: 4px solid #4CAF50; }
        .error { border-left: 4px solid #f44336; }
        .info { border-left: 4px solid #2196F3; }
        button {
            padding: 10px 20px;
            margin: 5px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background: #1976D2;
        }
    </style>
</head>
<body>
    <h1>New Collision System Test</h1>
    
    <div class="test-section">
        <h2>Test 1: UI Elements</h2>
        <button onclick="testUIElements()">Test UI Elements</button>
        <div id="ui-results"></div>
    </div>
    
    <div class="test-section">
        <h2>Test 2: Species Size Control</h2>
        <button onclick="testSpeciesSizeControl()">Test Species Size</button>
        <div id="size-results"></div>
    </div>
    
    <div class="test-section">
        <h2>Test 3: Collision Calculation</h2>
        <button onclick="testCollisionCalculation()">Test Collision</button>
        <div id="collision-results"></div>
    </div>
    
    <div class="test-section">
        <h2>Test 4: Link All Sizes</h2>
        <button onclick="testLinkAllSizes()">Test Link All Sizes</button>
        <div id="link-results"></div>
    </div>

    <script type="module">
        import { SimpleParticleSystem } from './src/core/SimpleParticleSystem.js';
        import { MainUI } from './src/ui/MainUI.js';
        import { PresetManager } from './src/utils/PresetManager.js';
        
        window.particleSystem = new SimpleParticleSystem(document.createElement('canvas'));
        window.presetManager = new PresetManager();
        
        function addResult(containerId, message, type = 'info') {
            const container = document.getElementById(containerId);
            const result = document.createElement('div');
            result.className = `test-result ${type}`;
            result.textContent = message;
            container.appendChild(result);
        }
        
        window.testUIElements = function() {
            const results = document.getElementById('ui-results');
            results.innerHTML = '';
            
            // Check if old elements are removed
            const oldElements = [
                'collision-radius',
                'collision-radius-value',
                'per-species-collision-enabled',
                'collision-multiplier',
                'collision-multiplier-control',
                'particle-size',
                'particle-size-value',
                'per-species-size-enabled',
                'per-species-size-controls'
            ];
            
            oldElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    addResult('ui-results', `❌ Old element '${id}' still exists!`, 'error');
                } else {
                    addResult('ui-results', `✅ Old element '${id}' removed`, 'success');
                }
            });
            
            // Check if new elements exist
            const newElements = [
                'collision-strength',
                'collision-strength-value',
                'link-all-sizes',
                'species-size',
                'species-size-value',
                'selected-species-name'
            ];
            
            newElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    addResult('ui-results', `✅ New element '${id}' exists`, 'success');
                } else {
                    addResult('ui-results', `❌ New element '${id}' missing!`, 'error');
                }
            });
        };
        
        window.testSpeciesSizeControl = function() {
            const results = document.getElementById('size-results');
            results.innerHTML = '';
            
            // Test species selection
            const speciesButtons = document.querySelectorAll('.species-btn');
            addResult('size-results', `Found ${speciesButtons.length} species buttons`, 'info');
            
            if (speciesButtons.length > 0) {
                // Click first species
                speciesButtons[0].click();
                
                setTimeout(() => {
                    const selectedName = document.getElementById('selected-species-name');
                    const sizeSlider = document.getElementById('species-size');
                    
                    if (selectedName && selectedName.textContent !== 'Select a species above') {
                        addResult('size-results', `✅ Species selected: ${selectedName.textContent}`, 'success');
                    } else {
                        addResult('size-results', `❌ Species selection failed`, 'error');
                    }
                    
                    if (sizeSlider && !sizeSlider.disabled) {
                        addResult('size-results', `✅ Size slider enabled`, 'success');
                        addResult('size-results', `Current size: ${sizeSlider.value}`, 'info');
                    } else {
                        addResult('size-results', `❌ Size slider not enabled`, 'error');
                    }
                }, 100);
            }
        };
        
        window.testCollisionCalculation = function() {
            const results = document.getElementById('collision-results');
            results.innerHTML = '';
            
            // Check particle system properties
            addResult('collision-results', `perSpeciesSize: ${particleSystem.perSpeciesSize}`, 'info');
            addResult('collision-results', `collisionMultiplier: ${particleSystem.collisionMultiplier}`, 'info');
            
            // Test collision calculation
            const species1Size = 5.0;
            const species2Size = 3.0;
            const multiplier = 1.5;
            
            const expectedCollision = (species1Size + species2Size) * multiplier;
            addResult('collision-results', `Test: Size1=${species1Size}, Size2=${species2Size}, Multiplier=${multiplier}`, 'info');
            addResult('collision-results', `Expected collision distance: ${expectedCollision}`, 'info');
            
            // Check if perSpeciesSize is always true
            if (particleSystem.perSpeciesSize === true) {
                addResult('collision-results', `✅ perSpeciesSize is always true`, 'success');
            } else {
                addResult('collision-results', `❌ perSpeciesSize is not true: ${particleSystem.perSpeciesSize}`, 'error');
            }
        };
        
        window.testLinkAllSizes = function() {
            const results = document.getElementById('link-results');
            results.innerHTML = '';
            
            const linkCheckbox = document.getElementById('link-all-sizes');
            const sizeSlider = document.getElementById('species-size');
            
            if (!linkCheckbox || !sizeSlider) {
                addResult('link-results', `❌ Required elements not found`, 'error');
                return;
            }
            
            // Test with link enabled
            linkCheckbox.checked = true;
            const testSize = 10.0;
            sizeSlider.value = testSize;
            sizeSlider.dispatchEvent(new Event('input'));
            
            setTimeout(() => {
                let allSame = true;
                for (let i = 0; i < particleSystem.species.length; i++) {
                    if (Math.abs(particleSystem.species[i].size - testSize) > 0.1) {
                        allSame = false;
                        break;
                    }
                }
                
                if (allSame) {
                    addResult('link-results', `✅ Link all sizes works - all species have size ${testSize}`, 'success');
                } else {
                    addResult('link-results', `❌ Link all sizes failed`, 'error');
                }
                
                // Test with link disabled
                linkCheckbox.checked = false;
                const species0Size = 5.0;
                particleSystem.species[0].size = species0Size;
                sizeSlider.value = 15.0;
                sizeSlider.dispatchEvent(new Event('input'));
                
                setTimeout(() => {
                    if (Math.abs(particleSystem.species[0].size - species0Size) < 0.1) {
                        addResult('link-results', `✅ Individual size control works when link is off`, 'success');
                    } else {
                        addResult('link-results', `❌ Individual size control failed`, 'error');
                    }
                }, 100);
            }, 100);
        };
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modulation System Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #0a0a0a;
            color: #fff;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .test-section {
            background: #1a1a1a;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .test-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #4a9eff;
        }
        .test-item {
            padding: 10px;
            margin: 5px 0;
            background: #2a2a2a;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .status.pass {
            background: #00ff00;
            color: #000;
        }
        .status.fail {
            background: #ff0000;
            color: #fff;
        }
        .status.pending {
            background: #ffaa00;
            color: #000;
        }
        button {
            background: #4a9eff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #3a8eef;
        }
        .log {
            background: #000;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
        }
        .firebase-status {
            padding: 10px;
            background: #2a2a2a;
            border-radius: 4px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <h1>Modulation System Test Suite</h1>
    
    <div class="test-section">
        <div class="test-title">Environment Check</div>
        <div class="test-item">
            <span>Current Environment</span>
            <span class="status pending" id="env-status">Checking...</span>
        </div>
        <div class="test-item">
            <span>Firebase Connection</span>
            <span class="status pending" id="firebase-status">Checking...</span>
        </div>
    </div>

    <div class="test-section">
        <div class="test-title">Test 1: Modulation Auto-Save to localStorage</div>
        <button onclick="testAutoSave()">Run Test</button>
        <div class="test-item">
            <span>Add modulation programmatically</span>
            <span class="status pending" id="test1-add">Pending</span>
        </div>
        <div class="test-item">
            <span>Check localStorage updated</span>
            <span class="status pending" id="test1-storage">Pending</span>
        </div>
        <div class="test-item">
            <span>Verify modulation in saved data</span>
            <span class="status pending" id="test1-verify">Pending</span>
        </div>
        <div class="log" id="test1-log"></div>
    </div>

    <div class="test-section">
        <div class="test-title">Test 2: Fetch Scene Data Includes Modulations</div>
        <button onclick="testFetchScene()">Run Test</button>
        <div class="test-item">
            <span>Add modulation</span>
            <span class="status pending" id="test2-add">Pending</span>
        </div>
        <div class="test-item">
            <span>Open preset modal</span>
            <span class="status pending" id="test2-modal">Pending</span>
        </div>
        <div class="test-item">
            <span>Fetch scene data</span>
            <span class="status pending" id="test2-fetch">Pending</span>
        </div>
        <div class="test-item">
            <span>Verify modulations preserved</span>
            <span class="status pending" id="test2-verify">Pending</span>
        </div>
        <div class="log" id="test2-log"></div>
    </div>

    <div class="test-section">
        <div class="test-title">Test 3: Preset Save/Load with Modulations</div>
        <button onclick="testPresetSaveLoad()">Run Test</button>
        <div class="test-item">
            <span>Add modulation</span>
            <span class="status pending" id="test3-add">Pending</span>
        </div>
        <div class="test-item">
            <span>Save preset</span>
            <span class="status pending" id="test3-save">Pending</span>
        </div>
        <div class="test-item">
            <span>Clear modulations</span>
            <span class="status pending" id="test3-clear">Pending</span>
        </div>
        <div class="test-item">
            <span>Load preset</span>
            <span class="status pending" id="test3-load">Pending</span>
        </div>
        <div class="test-item">
            <span>Verify modulations restored</span>
            <span class="status pending" id="test3-verify">Pending</span>
        </div>
        <div class="log" id="test3-log"></div>
    </div>

    <div class="test-section">
        <div class="test-title">Test 4: Page Refresh Persistence</div>
        <button onclick="testRefreshPersistence()">Setup Test</button>
        <button onclick="verifyRefreshPersistence()">Verify After Refresh</button>
        <div class="test-item">
            <span>Add modulation</span>
            <span class="status pending" id="test4-add">Pending</span>
        </div>
        <div class="test-item">
            <span>Save to localStorage</span>
            <span class="status pending" id="test4-save">Pending</span>
        </div>
        <div class="test-item">
            <span>Data exists after refresh</span>
            <span class="status pending" id="test4-exists">Pending</span>
        </div>
        <div class="test-item">
            <span>Modulation loaded correctly</span>
            <span class="status pending" id="test4-loaded">Pending</span>
        </div>
        <div class="log" id="test4-log"></div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, getDocs } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getAuth, signInAnonymously } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        
        // Check environment
        const isLocalhost = window.location.hostname === 'localhost';
        document.getElementById('env-status').textContent = isLocalhost ? 'Localhost' : 'Deployment';
        document.getElementById('env-status').className = 'status pass';
        
        // Check Firebase connection
        async function checkFirebase() {
            try {
                const firebaseConfig = {
                    apiKey: "AIzaSyD-zWilxTSa6N37gG3KMMGGuf6YzGm0ltY",
                    authDomain: "particle-life-synth.firebaseapp.com",
                    projectId: "particle-life-synth",
                    storageBucket: "particle-life-synth.firebasestorage.app",
                    messagingSenderId: "708800699341",
                    appId: "1:708800699341:web:36e85c7eabec2dbbabc284"
                };
                
                const app = initializeApp(firebaseConfig);
                const auth = getAuth(app);
                const db = getFirestore(app);
                
                await signInAnonymously(auth);
                const querySnapshot = await getDocs(collection(db, 'presets'));
                
                document.getElementById('firebase-status').textContent = `Connected (${querySnapshot.size} presets)`;
                document.getElementById('firebase-status').className = 'status pass';
                
                window.firebaseConnected = true;
            } catch (error) {
                document.getElementById('firebase-status').textContent = `Error: ${error.message}`;
                document.getElementById('firebase-status').className = 'status fail';
                window.firebaseConnected = false;
            }
        }
        
        checkFirebase();
        
        // Test functions
        window.testAutoSave = async function() {
            const log = document.getElementById('test1-log');
            log.innerHTML = '';
            
            try {
                // Navigate to main app
                const mainWindow = window.open('/', 'main-app');
                await new Promise(resolve => setTimeout(resolve, 3000));
                
                // Add a modulation
                log.innerHTML += 'Adding modulation...<br>';
                const result = mainWindow.eval(`
                    if (window.mainUI && window.mainUI.modulationManager) {
                        const modId = window.mainUI.modulationManager.addModulation(
                            'force_strength',
                            0.5,
                            2.0,
                            3000,
                            { min: 0, max: 5 },
                            'sine'
                        );
                        window.mainUI.updateModulationList();
                        window.mainUI.triggerAutoSave();
                        modId;
                    } else {
                        'No ModulationManager';
                    }
                `);
                
                if (result && result !== 'No ModulationManager') {
                    document.getElementById('test1-add').className = 'status pass';
                    log.innerHTML += `Modulation added with ID: ${result}<br>`;
                    
                    // Wait for auto-save
                    await new Promise(resolve => setTimeout(resolve, 2500));
                    
                    // Check localStorage
                    const lastScene = mainWindow.localStorage.getItem('lastScene');
                    if (lastScene) {
                        document.getElementById('test1-storage').className = 'status pass';
                        const sceneData = JSON.parse(lastScene);
                        
                        if (sceneData.modulations && sceneData.modulations.length > 0) {
                            document.getElementById('test1-verify').className = 'status pass';
                            log.innerHTML += `Found ${sceneData.modulations.length} modulations in localStorage<br>`;
                            log.innerHTML += `Modulation: ${JSON.stringify(sceneData.modulations[0], null, 2)}<br>`;
                        } else {
                            document.getElementById('test1-verify').className = 'status fail';
                            log.innerHTML += 'No modulations found in saved data<br>';
                        }
                    } else {
                        document.getElementById('test1-storage').className = 'status fail';
                        log.innerHTML += 'No lastScene in localStorage<br>';
                    }
                } else {
                    document.getElementById('test1-add').className = 'status fail';
                    log.innerHTML += 'Failed to add modulation<br>';
                }
                
                mainWindow.close();
            } catch (error) {
                log.innerHTML += `Error: ${error.message}<br>`;
                document.querySelectorAll('#test1-add, #test1-storage, #test1-verify').forEach(el => {
                    if (el.className === 'status pending') el.className = 'status fail';
                });
            }
        };
        
        window.testFetchScene = async function() {
            const log = document.getElementById('test2-log');
            log.innerHTML = '';
            
            try {
                const mainWindow = window.open('/', 'main-app');
                await new Promise(resolve => setTimeout(resolve, 3000));
                
                // Add modulation
                log.innerHTML += 'Adding modulation...<br>';
                mainWindow.eval(`
                    if (window.mainUI && window.mainUI.modulationManager) {
                        window.mainUI.modulationManager.addModulation(
                            'friction',
                            0.8,
                            0.95,
                            5000,
                            { min: 0.8, max: 1.0 },
                            'triangle'
                        );
                        window.mainUI.updateModulationList();
                    }
                `);
                document.getElementById('test2-add').className = 'status pass';
                
                // Open preset modal
                mainWindow.eval(`window.presetModal.open()`);
                await new Promise(resolve => setTimeout(resolve, 1000));
                document.getElementById('test2-modal').className = 'status pass';
                
                // Fetch scene data
                mainWindow.eval(`window.presetModal.fetchCurrentSceneSettings()`);
                await new Promise(resolve => setTimeout(resolve, 1000));
                document.getElementById('test2-fetch').className = 'status pass';
                
                // Check if modulations are in currentPreset
                const hasModulations = mainWindow.eval(`
                    window.presetModal.currentPreset && 
                    window.presetModal.currentPreset.modulations && 
                    window.presetModal.currentPreset.modulations.length > 0
                `);
                
                if (hasModulations) {
                    document.getElementById('test2-verify').className = 'status pass';
                    const modCount = mainWindow.eval(`window.presetModal.currentPreset.modulations.length`);
                    log.innerHTML += `Modulations preserved: ${modCount}<br>`;
                } else {
                    document.getElementById('test2-verify').className = 'status fail';
                    log.innerHTML += 'Modulations not preserved in fetched data<br>';
                }
                
                mainWindow.close();
            } catch (error) {
                log.innerHTML += `Error: ${error.message}<br>`;
            }
        };
        
        window.testPresetSaveLoad = async function() {
            const log = document.getElementById('test3-log');
            log.innerHTML = '';
            
            try {
                const mainWindow = window.open('/', 'main-app');
                await new Promise(resolve => setTimeout(resolve, 3000));
                
                // Add modulation
                mainWindow.eval(`
                    window.mainUI.modulationManager.addModulation(
                        'social_radius',
                        50,
                        200,
                        8000,
                        { min: 0, max: 300 },
                        'sine'
                    );
                    window.mainUI.updateModulationList();
                `);
                document.getElementById('test3-add').className = 'status pass';
                
                // Save as test preset
                const presetName = `ModTest_${Date.now()}`;
                mainWindow.eval(`
                    const preset = window.particleSystem.exportPreset();
                    preset.name = '${presetName}';
                    window.presetManager.savePreset('${presetName}', preset);
                `);
                await new Promise(resolve => setTimeout(resolve, 1000));
                document.getElementById('test3-save').className = 'status pass';
                
                // Clear modulations
                mainWindow.eval(`window.mainUI.modulationManager.clearAll()`);
                mainWindow.eval(`window.mainUI.updateModulationList()`);
                document.getElementById('test3-clear').className = 'status pass';
                
                // Load preset
                mainWindow.eval(`
                    const preset = window.presetManager.getPreset('${presetName}');
                    if (preset) {
                        window.particleSystem.loadFullPreset(preset);
                    }
                `);
                await new Promise(resolve => setTimeout(resolve, 1000));
                document.getElementById('test3-load').className = 'status pass';
                
                // Verify modulations restored
                const modCount = mainWindow.eval(`window.mainUI.modulationManager.getActiveModulations().length`);
                if (modCount > 0) {
                    document.getElementById('test3-verify').className = 'status pass';
                    log.innerHTML += `Modulations restored: ${modCount}<br>`;
                } else {
                    document.getElementById('test3-verify').className = 'status fail';
                    log.innerHTML += 'No modulations restored<br>';
                }
                
                mainWindow.close();
            } catch (error) {
                log.innerHTML += `Error: ${error.message}<br>`;
            }
        };
        
        window.testRefreshPersistence = function() {
            const log = document.getElementById('test4-log');
            log.innerHTML = '';
            
            // Add test modulation data to localStorage
            const testScene = {
                name: "Test Scene",
                modulations: [{
                    parameterId: "force_strength",
                    minValue: 0.5,
                    maxValue: 3.0,
                    duration: 5,
                    type: "float",
                    waveType: "sine",
                    parameterName: "Force Strength"
                }],
                species: { count: 5 },
                visual: { blur: 0.95 },
                physics: { friction: 0.05 }
            };
            
            localStorage.setItem('lastScene', JSON.stringify(testScene));
            localStorage.setItem('modulation_test_flag', 'true');
            
            document.getElementById('test4-add').className = 'status pass';
            document.getElementById('test4-save').className = 'status pass';
            
            log.innerHTML += 'Test data saved to localStorage<br>';
            log.innerHTML += 'Please refresh the page and click "Verify After Refresh"<br>';
        };
        
        window.verifyRefreshPersistence = function() {
            const log = document.getElementById('test4-log');
            log.innerHTML = '';
            
            const testFlag = localStorage.getItem('modulation_test_flag');
            if (!testFlag) {
                log.innerHTML += 'Please run "Setup Test" first, then refresh<br>';
                return;
            }
            
            const lastScene = localStorage.getItem('lastScene');
            if (lastScene) {
                document.getElementById('test4-exists').className = 'status pass';
                const sceneData = JSON.parse(lastScene);
                
                if (sceneData.modulations && sceneData.modulations.length > 0) {
                    document.getElementById('test4-loaded').className = 'status pass';
                    log.innerHTML += `Found ${sceneData.modulations.length} modulations after refresh<br>`;
                    
                    // Clean up test flag
                    localStorage.removeItem('modulation_test_flag');
                } else {
                    document.getElementById('test4-loaded').className = 'status fail';
                    log.innerHTML += 'Modulations missing after refresh<br>';
                }
            } else {
                document.getElementById('test4-exists').className = 'status fail';
                log.innerHTML += 'lastScene missing from localStorage<br>';
            }
        };
    </script>
</body>
</html>
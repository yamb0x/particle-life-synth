<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug IndexedDB and Storage</title>
    <style>
        body {
            background: #1a1a1a;
            color: #fff;
            font-family: monospace;
            padding: 20px;
        }
        pre {
            background: #000;
            padding: 10px;
            border: 1px solid #333;
            overflow: auto;
        }
        button {
            background: #4a9eff;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            border-radius: 4px;
        }
        button:hover {
            background: #5aa5ff;
        }
        .error {
            color: #ff4444;
        }
        .success {
            color: #44ff44;
        }
    </style>
</head>
<body>
    <h1>Storage Debug Tool</h1>
    
    <h2>Tests:</h2>
    <button onclick="testLocalStorage()">Test localStorage</button>
    <button onclick="testIndexedDB()">Test IndexedDB</button>
    <button onclick="checkStorageHealth()">Check Storage Health</button>
    <button onclick="listAllPresets()">List All Presets</button>
    <button onclick="clearAllStorage()">Clear All Storage</button>
    <button onclick="deleteIndexedDB()">Delete IndexedDB</button>
    
    <h2>Results:</h2>
    <pre id="output"></pre>
    
    <script type="module">
        import { PresetStorage } from './src/utils/PresetStorage.js';
        
        const output = document.getElementById('output');
        const storage = new PresetStorage();
        
        window.testLocalStorage = function() {
            output.innerHTML = '';
            try {
                // Test write
                localStorage.setItem('test', 'test value');
                output.innerHTML += '<span class="success">✓ localStorage write: OK</span>\n';
                
                // Test read
                const value = localStorage.getItem('test');
                output.innerHTML += '<span class="success">✓ localStorage read: ' + value + '</span>\n';
                
                // Test remove
                localStorage.removeItem('test');
                output.innerHTML += '<span class="success">✓ localStorage remove: OK</span>\n';
                
                // Check preset storage
                const presets = localStorage.getItem('particleLifePresets');
                if (presets) {
                    const parsed = JSON.parse(presets);
                    output.innerHTML += '\n<strong>Stored presets in localStorage:</strong>\n';
                    output.innerHTML += JSON.stringify(parsed, null, 2);
                } else {
                    output.innerHTML += '\n<span class="error">No presets found in localStorage</span>';
                }
            } catch (error) {
                output.innerHTML += '<span class="error">✗ localStorage error: ' + error.message + '</span>\n';
            }
        };
        
        window.testIndexedDB = async function() {
            output.innerHTML = '';
            try {
                // Wait for IndexedDB to initialize
                output.innerHTML += 'Waiting for IndexedDB...\n';
                await storage.dbReady;
                output.innerHTML += '<span class="success">✓ IndexedDB ready</span>\n';
                output.innerHTML += 'DB object: ' + (storage.db ? 'Available' : 'Not available') + '\n\n';
                
                // Test save
                const testKey = 'test_preset_' + Date.now();
                const testPreset = {
                    key: testKey,
                    name: 'Test Preset',
                    version: '1.0',
                    species: { count: 5, definitions: [] },
                    physics: {},
                    visual: {},
                    forces: {},
                    created: new Date().toISOString(),
                    modified: new Date().toISOString()
                };
                
                output.innerHTML += 'Saving test preset with key: ' + testKey + '\n';
                await storage.saveToIndexedDB(testKey, testPreset);
                output.innerHTML += '<span class="success">✓ IndexedDB save: OK</span>\n';
                
                // Test load
                output.innerHTML += 'Loading test preset...\n';
                const loaded = await storage.loadFromIndexedDB(testKey);
                output.innerHTML += '<span class="success">✓ IndexedDB load: ' + (loaded ? 'OK' : 'FAILED') + '</span>\n';
                if (loaded) {
                    output.innerHTML += 'Loaded preset name: ' + loaded.name + '\n';
                }
                
                // List all
                output.innerHTML += '\nListing all presets...\n';
                const all = await storage.getAllFromIndexedDB();
                output.innerHTML += '\n<strong>All presets in IndexedDB:</strong>\n';
                output.innerHTML += JSON.stringify(all, null, 2);
                
            } catch (error) {
                output.innerHTML += '<span class="error">✗ IndexedDB error: ' + error.message + '</span>\n';
                output.innerHTML += '<span class="error">Stack: ' + error.stack + '</span>\n';
            }
        };
        
        window.checkStorageHealth = async function() {
            output.innerHTML = '';
            try {
                const health = await storage.checkStorageHealth();
                output.innerHTML += '<strong>Storage Health Check:</strong>\n';
                output.innerHTML += 'localStorage: ' + (health.localStorage ? 
                    '<span class="success">✓ Available</span>' : 
                    '<span class="error">✗ Not Available</span>') + '\n';
                output.innerHTML += 'IndexedDB: ' + (health.indexedDB ? 
                    '<span class="success">✓ Available</span>' : 
                    '<span class="error">✗ Not Available</span>') + '\n';
                output.innerHTML += 'Total Presets: ' + health.totalPresets + '\n';
                output.innerHTML += 'Storage Used: ' + (health.storageUsed / 1024).toFixed(2) + ' KB\n';
            } catch (error) {
                output.innerHTML += '<span class="error">✗ Health check error: ' + error.message + '</span>\n';
            }
        };
        
        window.listAllPresets = async function() {
            output.innerHTML = '';
            try {
                const all = await storage.getAllPresets();
                output.innerHTML += '<strong>All Presets (Combined):</strong>\n';
                for (const [key, preset] of Object.entries(all)) {
                    output.innerHTML += '\n<strong>' + key + ':</strong>\n';
                    output.innerHTML += '  Name: ' + preset.name + '\n';
                    output.innerHTML += '  Version: ' + preset.version + '\n';
                    output.innerHTML += '  Created: ' + (preset.created || 'N/A') + '\n';
                    output.innerHTML += '  Modified: ' + (preset.modified || 'N/A') + '\n';
                }
            } catch (error) {
                output.innerHTML += '<span class="error">✗ List error: ' + error.message + '</span>\n';
            }
        };
        
        window.clearAllStorage = function() {
            if (confirm('This will clear ALL stored presets. Are you sure?')) {
                localStorage.removeItem('particleLifePresets');
                localStorage.removeItem('particleLifePresetsMeta');
                
                if (storage.db) {
                    const transaction = storage.db.transaction(['presets'], 'readwrite');
                    const store = transaction.objectStore('presets');
                    store.clear();
                }
                
                output.innerHTML = '<span class="success">✓ All storage cleared</span>';
            }
        };
        
        window.deleteIndexedDB = async function() {
            if (confirm('This will delete the entire IndexedDB database. Are you sure?')) {
                output.innerHTML = 'Closing database...\n';
                if (storage.db) {
                    storage.db.close();
                }
                
                output.innerHTML += 'Deleting database...\n';
                const deleteReq = indexedDB.deleteDatabase('ParticleLifeDB');
                
                deleteReq.onsuccess = () => {
                    output.innerHTML += '<span class="success">✓ IndexedDB deleted successfully</span>\n';
                    output.innerHTML += 'Please refresh the page to recreate the database.';
                };
                
                deleteReq.onerror = () => {
                    output.innerHTML += '<span class="error">✗ Failed to delete IndexedDB</span>';
                };
                
                deleteReq.onblocked = () => {
                    output.innerHTML += '<span class="error">✗ Database delete blocked - close all tabs and try again</span>';
                };
            }
        };
        
        // Auto-run health check on load
        setTimeout(() => checkStorageHealth(), 1000);
    </script>
</body>
</html>
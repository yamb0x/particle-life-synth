<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Controls Test</title>
    <link rel="stylesheet" href="src/styles/design-system.css">
    <style>
        body {
            background: #1a1a2e;
            color: white;
            padding: 20px;
            font-family: system-ui, -apple-system, sans-serif;
        }
        
        .test-container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .test-status {
            background: #2a2a3e;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .test-status.success {
            border-left: 4px solid #4caf50;
        }
        
        .test-status.error {
            border-left: 4px solid #f44336;
        }
        
        .test-controls {
            background: #2a2a3e;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        button {
            background: #4a4a6e;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        button:hover {
            background: #5a5a7e;
        }
        
        .log-output {
            background: #1a1a2e;
            border: 1px solid #3a3a4e;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        
        .species-controls-container {
            background: #2a2a3e;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>Audio Controls Test</h1>
        
        <div class="test-status" id="status">
            <h3>Status</h3>
            <div id="status-content">Initializing...</div>
        </div>
        
        <div class="test-controls">
            <h3>Test Controls</h3>
            <button id="init-audio">Initialize Audio System</button>
            <button id="load-samples">Load Random Samples</button>
            <button id="test-grain-size">Test Grain Size</button>
            <button id="test-grain-density">Test Grain Density</button>
            <button id="test-pitch">Test Pitch Shift</button>
            <button id="test-volume">Test Volume</button>
            <button id="test-all">Run All Tests</button>
        </div>
        
        <div class="test-controls">
            <h3>Log Output</h3>
            <div id="log" class="log-output"></div>
        </div>
        
        <div class="species-controls-container" id="species-controls">
            <h3>Species Audio Controls</h3>
            <div id="controls-mount"></div>
        </div>
    </div>

    <script type="module">
        import { getAudioSystem } from './src/audio/AudioSystem.js';
        import { SpeciesAudioControl } from './src/ui/SpeciesAudioControl.js';
        
        const log = (message, type = 'info') => {
            const logEl = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#f44336' : 
                         type === 'success' ? '#4caf50' : 
                         type === 'warn' ? '#ff9800' : '#999';
            logEl.innerHTML += `<span style="color: ${color}">[${timestamp}] ${message}</span>\n`;
            logEl.scrollTop = logEl.scrollHeight;
            console.log(`[Test] ${message}`);
        };
        
        const updateStatus = (message, isSuccess = null) => {
            const statusEl = document.getElementById('status');
            const contentEl = document.getElementById('status-content');
            contentEl.textContent = message;
            
            statusEl.classList.remove('success', 'error');
            if (isSuccess !== null) {
                statusEl.classList.add(isSuccess ? 'success' : 'error');
            }
        };
        
        let audioSystem = null;
        let speciesControls = [];
        
        // Initialize audio button
        document.getElementById('init-audio').addEventListener('click', async () => {
            try {
                log('Initializing audio system...');
                updateStatus('Initializing audio system...');
                
                audioSystem = getAudioSystem();
                await audioSystem.initialize(800, 600);
                
                log('Audio system initialized successfully', 'success');
                updateStatus('Audio system ready', true);
                
                // Create species controls
                const controlsMount = document.getElementById('controls-mount');
                controlsMount.innerHTML = '';
                
                for (let i = 0; i < 4; i++) {
                    const control = new SpeciesAudioControl(audioSystem, i);
                    const element = control.createElement();
                    controlsMount.appendChild(element);
                    speciesControls.push(control);
                    log(`Created control for species ${i}`);
                }
                
            } catch (error) {
                log(`Error: ${error.message}`, 'error');
                updateStatus(`Error: ${error.message}`, false);
            }
        });
        
        // Load samples button
        document.getElementById('load-samples').addEventListener('click', async () => {
            if (!audioSystem) {
                log('Audio system not initialized', 'error');
                return;
            }
            
            try {
                log('Loading random samples for all species...');
                await audioSystem.randomizeAllSamples();
                log('Samples loaded successfully', 'success');
                
                // Check if synthesizers have samples
                for (let i = 0; i < 4; i++) {
                    const synth = audioSystem.getSynthesizer(i);
                    if (synth) {
                        const state = synth.getState();
                        log(`Species ${i}: ${state.sampleName || 'No sample'}`);
                    }
                }
            } catch (error) {
                log(`Error loading samples: ${error.message}`, 'error');
            }
        });
        
        // Test grain size
        document.getElementById('test-grain-size').addEventListener('click', () => {
            if (!audioSystem) {
                log('Audio system not initialized', 'error');
                return;
            }
            
            log('Testing grain size changes...');
            const synth = audioSystem.getSynthesizer(0);
            if (synth) {
                const originalSize = synth.grainSize;
                log(`Original grain size: ${originalSize}ms`);
                
                synth.setGrainSize(200);
                log(`Set grain size to 200ms, actual: ${synth.grainSize}ms`);
                
                synth.setGrainSize(50);
                log(`Set grain size to 50ms, actual: ${synth.grainSize}ms`);
                
                synth.setGrainSize(originalSize);
                log(`Restored to ${originalSize}ms`);
                
                log('Grain size test complete', 'success');
            } else {
                log('No synthesizer found for species 0', 'error');
            }
        });
        
        // Test grain density
        document.getElementById('test-grain-density').addEventListener('click', () => {
            if (!audioSystem) {
                log('Audio system not initialized', 'error');
                return;
            }
            
            log('Testing grain density changes...');
            const synth = audioSystem.getSynthesizer(0);
            if (synth) {
                const originalDensity = synth.grainDensity;
                log(`Original grain density: ${originalDensity} gr/s`);
                
                synth.setGrainDensity(50);
                log(`Set grain density to 50 gr/s, actual: ${synth.grainDensity} gr/s`);
                
                synth.setGrainDensity(10);
                log(`Set grain density to 10 gr/s, actual: ${synth.grainDensity} gr/s`);
                
                synth.setGrainDensity(originalDensity);
                log(`Restored to ${originalDensity} gr/s`);
                
                log('Grain density test complete', 'success');
            } else {
                log('No synthesizer found for species 0', 'error');
            }
        });
        
        // Test pitch shift
        document.getElementById('test-pitch').addEventListener('click', () => {
            if (!audioSystem) {
                log('Audio system not initialized', 'error');
                return;
            }
            
            log('Testing pitch shift changes...');
            const synth = audioSystem.getSynthesizer(0);
            if (synth) {
                const originalPitch = synth.pitchShift;
                log(`Original pitch shift: ${originalPitch} semitones`);
                
                synth.setPitchShift(12);
                log(`Set pitch shift to +12 st, actual: ${synth.pitchShift} st`);
                
                synth.setPitchShift(-12);
                log(`Set pitch shift to -12 st, actual: ${synth.pitchShift} st`);
                
                synth.setPitchShift(originalPitch);
                log(`Restored to ${originalPitch} st`);
                
                log('Pitch shift test complete', 'success');
            } else {
                log('No synthesizer found for species 0', 'error');
            }
        });
        
        // Test volume
        document.getElementById('test-volume').addEventListener('click', () => {
            if (!audioSystem) {
                log('Audio system not initialized', 'error');
                return;
            }
            
            log('Testing volume changes...');
            const synth = audioSystem.getSynthesizer(0);
            if (synth) {
                const originalVolume = synth.volume;
                log(`Original volume: ${originalVolume} dB`);
                
                synth.setVolume(-12);
                log(`Set volume to -12 dB, actual: ${synth.volume} dB`);
                
                synth.setVolume(3);
                log(`Set volume to +3 dB, actual: ${synth.volume} dB`);
                
                synth.setVolume(originalVolume);
                log(`Restored to ${originalVolume} dB`);
                
                log('Volume test complete', 'success');
            } else {
                log('No synthesizer found for species 0', 'error');
            }
        });
        
        // Test all
        document.getElementById('test-all').addEventListener('click', async () => {
            log('Running all tests...', 'warn');
            
            // Click all test buttons in sequence
            const buttons = [
                'init-audio',
                'load-samples',
                'test-grain-size',
                'test-grain-density',
                'test-pitch',
                'test-volume'
            ];
            
            for (const buttonId of buttons) {
                document.getElementById(buttonId).click();
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
            
            log('All tests complete!', 'success');
            updateStatus('All tests complete', true);
        });
        
        // Initial message
        log('Test page loaded. Click "Initialize Audio System" to begin.');
        updateStatus('Ready to initialize');
    </script>
</body>
</html>